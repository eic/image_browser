<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Gallery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" async></script>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>

<style>
    body,
    html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .navbar {
        background-color: #f8f8f8;
        color: #333;
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 5px;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1030;
    }

    .nav-logo a,
    .nav-links a {
        color: #000;
        text-decoration: none;
        margin: 0 15px;
        font-size: 18px;
    }

    .nav-links a:hover {
        color: #555;
    }

    .container {
        display: flex;
        height: calc(100vh - 50px);
        /* Adjust height based on navbar height */
    }

    #sidebar {
        position: relative;
        width: 100%;
        height: auto;
        overflow-y: auto;
        box-shadow: 3px 0px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        top: 100px;
        left: 0;
    }

    .selector {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
    }

    .form-label {
        margin-top: 15px;
    }

    #imageGallery,
    #galleryInfo {
        position: relative;
        /* Ensure they flow normally within the document */
        top: 0;
        left: 0;
        width: 100%;
        /* Full width for smaller screens */
        padding: 10px;
        background-color: #ffffff;
        box-sizing: border-box;
        /* Padding included in width */
    }

    #imageGallery {
        height: auto;
        /* Flexible height */
        overflow-y: auto;
        /* Allow vertical scrolling */
        display: flex;
        flex-wrap: wrap;
        /* Responsive image wrapping */
    }

    /* Medium screens and larger */
    @media (min-width: 768px) {
        #sidebar {
            position: fixed;
            /* Fixed position on larger screens */
            top: 100px;
            /* Set the top offset */
            left: 0;
            /* Aligned to the left edge */
            width: 300px;
            /* Fixed width */
            height: calc(100% - 100px);
            /* Adjusted height based on the top offset */
        }

        #mainContent {
            margin-left: 300px;
            /* Offset main content to avoid overlapping with the sidebar */
        }

        #imageGallery {
            position: relative;
            /* Maintain relative positioning for flexibility */
            left: 0;
            /* Align left edge with the content area */
            width: calc(100% - 300px);
            /* Adjust width to account for sidebar */
            margin-top: 50px;
        }

        #galleryInfo {
            position: relative;
            /* Keep relative to flow with document layout */
            left: 0;
            /* Align with main content */
            top: 0;
            /* Reset top alignment */
        }
    }

    .d-flex {
        display: flex !important;
        flex-wrap: wrap;
    }

    .ms-2 {
        margin-left: 10px;
        margin-right: 3.0rem !important;
    }

    .gallery img {
        margin: 10px;
        width: 200px;
        height: auto;
        border-radius: 8px;
        transition: transform 0.2s ease-in-out;

    }

    .card-text-container {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        /* or use flex-start/flex-end depending on your layout */
    }

    .card-text {
        margin: 0;
        padding-right: 10px;
        /* Adjust as necessary */
    }


    .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }


    .gallery img:hover {
        transform: scale(1.05);
    }

    .footer {
        background: #f8f8f8;
        padding: 10px 0;
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        text-align: center;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }

    .footer .btn-link {
        color: #333;
        text-decoration: none;
    }

    .footer .card {
        width: auto;
    }

    .card-body {
        font-size: 0.9rem;
        padding: 8px;
    }

    nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        align-items: center;
    }

    nav ul li {
        position: relative;
        margin-right: 20px;
    }

    nav ul li a {
        text-decoration: none;
        color: black;
        display: block;
        padding: 5px;
    }

    .submenu {
        display: none;
        position: absolute;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        width: auto;
        z-index: 1000;
    }

    nav ul li:hover .submenu {
        display: block;
        /* Show submenu on hover */
    }

    .submenu a {
        display: block;
        padding: 10px;
        border-bottom: 1px solid #ccc;
        color: black;
        text-decoration: none;
    }

    .submenu a:hover {
        background-color: #f9f9f9;
    }

    .submenu a:last-child {
        border-bottom: none;
    }

    #imageGallery.single-plot {
        justify-content: flex-start;
    }

    .breadcrumb {
        padding: 8px 15px;
        margin-bottom: 0;
        background-color: #f8f9fa;
        /* Light grey background */
        border-radius: 0.25rem;
        list-style-type: none;
        display: flex;
    }

    .breadcrumb-item {
        display: inline;
    }

    .breadcrumb-item:first-child::before {
        content: none;
        /* No content for the first item */
    }

    .breadcrumb-item+.breadcrumb-item::after {
        content: "/";
        /* Custom separator */
        padding: 0 5px;
        color: #6c757d;
        /* Bootstrap's default secondary text color */
        display: inline;
    }

    .breadcrumb-item a {
        text-decoration: none;
    }

    .breadcrumb-item.active a {
        color: #6c757d;
        /* Bootstrap's default secondary text color */
        pointer-events: none;
        /* Makes the link non-clickable */
        cursor: default;
    }

    .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        /* Stay in place */
        z-index: 20;
        /* Sit on top */
        left: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.4);
        /* Black w/ opacity */
    }

    .modal-content {
        position: relative;
        top: 30px;
        background-color: #fefefe;
        margin: 10% auto;
        /* 10% from the top and centered */
        padding: 50px;
        padding-top: 100px;
        padding-bottom: 100px;
        border: 1px solid #888;
        width: 100%;
        /* Could be more or less, depending on screen size */
    }

    .close {
        position: absolute;
        color: #aaa;
        right: 30px;
        font-size: 28px;
        cursor: pointer;
    }

    input[type="text"],
    input[type="email"],
    input[type="file"],
    textarea {
        width: 60%;
        padding: 12px;
        margin: 8px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
    }

    input[type="submit"] {
        width: 60%;
        background-color: black;
        color: white;
        padding: 14px 20px;
        margin: 8px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    input[type="submit"]:hover {
        background-color: gray;
    }

    .modal-tabs {
        overflow: hidden;
        border-radius: 8px;
        background-color: rgb(247, 247, 247);
        padding: 10px;
        width: 260px;
    }

    .tablink {
        background-color: inherit;
        border-radius: 8px;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
    }

    .tablink:hover {
        background-color: #ddd;
    }

    /* Active tab style */
    .tablink.active {
        background-color: white;
        /* Light grey background for the active tab */
    }

    #formHeaderContact {
        font-weight: 900;
        margin-top: 80px;
        padding: 10px;
    }

    #formHeaderAddPlot {
        font-weight: 900;
        margin-top: 80px;
        padding: 10px;
    }

    #searchBar {
        margin: 0;
    }

    .btn-custom {
        background-color: black;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
    }

    .about-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20rem;
        padding-left: 10px;
    }

    .about-section img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-top: 35px;
        padding: 20px;
    }

    .about-section h1 {
        font-weight: bold;
        font-size: 4rem;
    }

    /*make first p section have gray font color*/
    .about-section p:first-of-type {
        color: gray;
    }

    .about-section p {
        font-size: 1.3rem;
    }


    .col-md-6 {
        padding-left: 40px;
    }

    .fa-download {
        margin-left: 30px;
        color: gray;
        vertical-align: bottom;
        /* Align with the middle of the text */
    }

    select[multiple] {
        font-size: 16px;
        /* Increase the font size */
        height: 400px;
        /* Automatically adjust the height */
        width: 250px;
        /* Set a custom width */
        padding: 10px;
        /* Add padding to increase the size */
    }
</style>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="./EPIC-logo_black_transparent.png" alt="epic logo" width="75px"
                    height="auto"></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" id="homeLink" href="#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="physicsLink">Physics</a>
                        <div id="PhysicsSubmenu" class="submenu"></div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="detectorLink">Detector</a>
                        <div id="DetectorSubmenu" class="submenu"></div>
                    </li>
                    <li>
                        <a class="nav-link" href="#" id="ciLink">CI</a>
                    </li>
                    <li class="nav-item">
                        <a class=" btn-custom" href="mailto:roark@jlab.org" id="contactLink">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="modal" class="modal">
        <div class="modal-content">
            <!--<span class="close">&times;</span>-->
            <div class="modal-tabs">
                <button class="tablink" onclick="openForm(event, 'Contact')">Contact</button>
                <button class="tablink" onclick="openForm(event, 'AddPlot')">Add a new plot</button>
            </div>
            <div id="Contact" class="tabcontent">
                <div id="formHeaderContact">
                    <h2>Contact</h2>
                </div>
                <form id="contactForm" method="POST">
                    <input type="text" id="firstName" name="firstName" placeholder="First name" required><br>
                    <input type="text" id="lastName" name="lastName" placeholder="Last name" required><br>
                    <input type="email" id="email" name="email" placeholder="Email address" required><br>
                    <textarea id="message" name="message" placeholder="Your message" required></textarea><br>
                    <input type="submit" value="Submit">
                </form>
            </div>
            <div id="AddPlot" class="tabcontent">
                <div id="formHeaderAddPlot">
                    <h2>Add a new plot type</h2>
                </div>
                <div id="reminder">
                    <p>Macros/scripts should be submitted to the benchmarks repository in GitLab <a
                            href="https://eicweb.phy.anl.gov/EIC/benchmarks" target="_blank"><i
                                class="fab fa-gitlab"></i></a>. Alternatively, you may use this form. </p>
                </div>
                <form id="addPlotForm">
                    <input type="text" id="name" name="name" placeholder="Your Name" required><br>
                    <input type="text" id="workingGroup" name="workingGroup" placeholder="Working Group" required><br>
                    <input type="text" id="plotName" name="plotName" placeholder="Name of Plot" required><br>
                    <textarea id="description" name="description" placeholder="Brief description of the plot"
                        required></textarea><br>
                    <textarea id="instructions" name="instructions" placeholder="Special instructions for running?"
                        required></textarea><br>
                    <input type="file" id="plotFile" name="plotFile[]" multiple required><br>
                    <input type="submit" value="Submit">
                </form>
            </div>
        </div>
    </div>


    <div id="dynamicContent" class="container-fluid"></div>
    <footer class="footer">
        <p><i class="fa-solid fa-triangle-exclamation"></i> Plots on this page are automatically generated and are not
            approved for use in presentations or other documents. </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        populateSubmenus();
        loadHomePage();  // Load home page content by default

        document.body.addEventListener("click", function (e) {
            if (e.target.closest('#homeLink')) {
                e.preventDefault(); // Prevent default link behavior
                loadHomePage();
            } else if (e.target.closest('.submenu a')) {
                var plotGroup = e.target.getAttribute("data-plotgroup-id");

                if (plotGroup) {
                    populateSidebar(plotGroup);
                    loadOriginalContent(plotGroup);
                }
            }
        });
    });

    function updateImageGallery() {
        console.log('updateImageGallery called');

        var campaignSelect = document.getElementById("CampaignSelect");
        var plotTypeSelect = document.getElementById("PlotTypesSelect");
        var geometrySelect = document.getElementById("GeometrySelect");
        var energySelect = document.getElementById("BeamEnergySelect");
        var minQ2Select = document.getElementById("MinQ2Select");
        var particleTypeSelect = document.getElementById("ParticleTypeSelect");
        var pipelineSelect = document.getElementById("PipelineSelect");

        var campaigns = campaignSelect ? Array.from(campaignSelect.selectedOptions).map(option => option.value) : [];
        var plotTypes = plotTypeSelect ? Array.from(plotTypeSelect.selectedOptions).map(option => option.value) : [];
        var energies = energySelect ? Array.from(energySelect.selectedOptions).map(option => option.value) : [];
        var geometries = geometrySelect ? Array.from(geometrySelect.selectedOptions).map(option => option.value) : [];
        var minQ2s = minQ2Select ? Array.from(minQ2Select.selectedOptions).map(option => option.value) : [];
        var particleTypes = particleTypeSelect ? Array.from(particleTypeSelect.selectedOptions).map(option => option.value) : [];
        var pipelines = pipelineSelect ? Array.from(pipelineSelect.selectedOptions).map(option => option.value) : [];

        // Clear current images
        var imageGallery = document.getElementById('imageGallery');
        imageGallery.innerHTML = '';

        if (plotTypes.length === 1) {
            imageGallery.classList.add("single-plot");
        } else {
            imageGallery.classList.remove("single-plot");
        }

        if (plotTypes.includes('all')) {
            plotTypes = Array.from(plotTypeSelect.options).map(option => option.value).filter(value => value !== 'all');
        }

        // Determine if IsChunked should be 1 or 0
        var IsChunked = pipelines.length > 0 ? 1 : 0;

        // Loop through each plot type and fetch images
        plotTypes.forEach(plotType => {
            var cardDeckDiv = document.createElement("div");
            cardDeckDiv.className = "d-flex flex-row mb-4 flex-wrap";

            // Variables to hold header and subheader
            var header = document.createElement("h2");
            header.className = "text-left";
            header.style.fontSize = "24px";

            var headerSet = false; // Flag to check if header text is set
            var headerAppended = false; // Flag to check if header has been appended to the DOM

            // Fetch image paths from the PHP script
            fetch(`/epic/php/images.php?plotName=${encodeURIComponent(plotType)}&IsChunked=${IsChunked}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        console.error('No data received from the server for plotType:', plotType);
                        return;
                    }

                    // Set header text using DisplayName from the first plot
                    if (!headerSet) {
                        let displayText = data[0].DisplayName || plotType.replace(".png", "");
                        header.textContent = displayText;
                        headerSet = true;
                    }

                    // Variable to hold subheader if needed
                    var subHeader = null;
                    // Check if Description is available and different from DisplayName
                    if (data[0].Description && data[0].Description !== data[0].DisplayName) {
                        // Create the subheader element
                        subHeader = document.createElement("h3");
                        subHeader.style.fontSize = "18px"; // Set font size for subheader
                        subHeader.style.fontWeight = "normal"; // Make subheader less bold than header
                        subHeader.style.marginTop = "5px"; // Optional: Add some spacing
                        subHeader.textContent = data[0].Description;
                    }

                    var results = data.map(plot => {
                        const pathParts = plot.ImagePath.split('/');

                        let pipeline = null;
                        let pipeline_id = null;
                        let campaign = null;
                        let geometry = null;
                        let energy = null;
                        let minQ2 = null;

                        // Check if the path contains 'images' directory and determine indices accordingly
                        const imagesIndex = pathParts.indexOf('images');
                        const pipelinesIndex = pathParts.indexOf('pipelines');

                        if (pipelinesIndex !== -1) {
                            pipeline = pathParts.length > pipelinesIndex + 1 ? pathParts[pipelinesIndex + 1] : null;
                            if (pipeline) {
                                let pipelineParts = pipeline.split('-');
                                pipeline_id = pipelineParts.length > 1 ? pipelineParts[1] : null;
                            }
                        }

                        if (imagesIndex !== -1 && IsChunked === 0) {
                            // For non-CI plots, extract campaign info
                            // If 'images' directory is found, the campaign (if any) should be the next directory
                            campaign = pathParts.length > imagesIndex + 1 ? pathParts[imagesIndex + 1] : null;

                            // Check if the campaign is actually a known campaign or just a directory like 'MaterialScan'
                            const knownCampaigns = campaigns.length > 0 ? campaigns : []; // List of known campaigns
                            if (!knownCampaigns.includes(campaign)) {
                                // If not a known campaign, set campaign to null
                                campaign = null;
                            }

                            geometry = pathParts.length > imagesIndex + 2 ? pathParts[imagesIndex + 2] : null;
                            energy = pathParts.length > imagesIndex + 5 ? pathParts[imagesIndex + 5] : null;
                            minQ2 = pathParts.length > imagesIndex + 6 ? (pathParts[imagesIndex + 6].split("=")[1] || null) : null;
                        }

                        const hasPipeline = pipelines.length === 0 || (pipeline_id && pipelines.includes(pipeline_id));
                        const hasCampaign = campaigns.length === 0 || (campaign && campaigns.includes(campaign));
                        const hasGeometry = geometries.length === 0 || (geometry && geometries.includes(geometry));
                        const hasEnergy = energies.length === 0 || (energy && energies.includes(energy));
                        const hasMinQ2 = minQ2s.length === 0 || (minQ2 && minQ2s.includes(minQ2));
                        const hasParticleType = particleTypes.length === 0 || particleTypes.some(pt => plot.PlotTypeName.includes(pt));

                        // Include hasPipeline in the condition
                        if (hasPipeline && hasCampaign && hasGeometry && hasEnergy && hasMinQ2 && hasParticleType) {
                            var colDiv = document.createElement("div");
                            colDiv.className = "col-md-4";
                            colDiv.setAttribute('data-campaign', campaign); // Add data attribute for sorting

                            var cardDiv = document.createElement("div");
                            cardDiv.className = "card mb-4 mx-2";

                            var link = document.createElement("a");
                            link.setAttribute('data-href', plot.ImagePath + plot.PlotTypeName + ".png");
                            link.target = "_blank";
                            link.rel = "noopener noreferrer"; // For security

                            // Set href on click to prevent prefetching
                            link.addEventListener('click', function (event) {
                                event.preventDefault(); // Prevent default action
                                var url = link.getAttribute('data-href');
                                window.open(url, '_blank');
                            });

                            /*
                            var img = document.createElement("img");
                            img.style.paddingTop = "10px";
                            img.src = plot.ImagePath + plot.PlotTypeName + ".png";
                            img.className = "card-img-top image-item";
                            img.alt = plot.PlotTypeName;
                            */
                            var img = document.createElement("img");
                            img.style.paddingTop = "10px";
                            img.setAttribute('data-src', plot.ImagePath + plot.PlotTypeName + ".png");
                            img.className = "card-img-top image-item lazyload"; // Add 'lazyload' class
                            img.alt = plot.PlotTypeName;

                            var tooltipText = `Path: ${plot.ImagePath}`;
                            img.title = tooltipText;

                            var cardBodyDiv = document.createElement("div");
                            cardBodyDiv.className = "card-body";

                            var cardTextContainer = document.createElement("div");
                            cardTextContainer.className = "card-text-container";

                            var campaignInfo = document.createElement("p");
                            campaignInfo.className = "card-text";
                            let campaignTextItems = [];

                            if (IsChunked === 1) {
                                // For CI plots, only add Pipeline ID
                                if (pipeline_id) {
                                    campaignTextItems.push(`Pipeline ID: ${pipeline_id}`);
                                }
                            } else {
                                // For non-CI plots, include campaign info
                                if (campaign) {
                                    campaignTextItems.push(`Campaign: ${campaign}`);
                                }

                                // Parse energy to a float and check if it's a valid number
                                let sanitizedEnergy = energy ? energy.replace(/[^0-9.-]+/g, '') : null;
                                let energyValue = sanitizedEnergy ? parseFloat(sanitizedEnergy) : null;

                                if (!isNaN(energyValue)) {
                                    campaignTextItems.push(`Energy: ${energy}`);
                                }

                                if (minQ2) {
                                    campaignTextItems.push(`Min QÂ²: ${minQ2}`);
                                }
                            }

                            // If there are any campaign info items, join them and set the innerHTML
                            if (campaignTextItems.length > 0) {
                                campaignInfo.innerHTML = campaignTextItems.join('<br>');
                            }

                            var downloadIcon = document.createElement("i");
                            downloadIcon.className = "fas fa-download";
                            downloadIcon.title = "Download Image";

                            downloadIcon.addEventListener('click', function(event) {
                                event.stopPropagation();
                                event.preventDefault(); // Prevent default action
                            
                                var img = cardDiv.querySelector('img');
                            
                                // Check if the image is loaded
                                if (img.complete && img.naturalHeight !== 0) {
                                    // Proceed with download
                                    downloadCardAsPNG(cardDiv, downloadIcon);
                                } else {
                                    // Wait for the image to load
                                    img.addEventListener('load', function onImageLoad() {
                                        // Remove the event listener to prevent multiple triggers
                                        img.removeEventListener('load', onImageLoad);
                                        downloadCardAsPNG(cardDiv, downloadIcon);
                                    });
                                }
                            }, { once: true });

                            // Create a link for the download icon
                            var downloadLink = document.createElement("a");
                            downloadLink.href = plot.ImagePath + plot.PlotTypeName + ".png";
                            downloadLink.download = plot.PlotTypeName + ".png"; // Set the download attribute with file name
                            downloadLink.appendChild(downloadIcon);

                            cardTextContainer.appendChild(campaignInfo);
                            cardTextContainer.appendChild(downloadLink);

                            cardDiv.appendChild(link);
                            link.appendChild(img);
                            cardBodyDiv.appendChild(cardTextContainer);
                            cardDiv.appendChild(cardBodyDiv);
                            colDiv.appendChild(cardDiv);

                            return { minQ2: parseFloat(minQ2) || 0, element: colDiv }; // Return object with minQ2 and the DOM element
                        }
                        return null;
                    }).filter(item => item !== null);

                    // Now sort results and display them
                    results.sort((a, b) => a.minQ2 - b.minQ2); // Sort results by minQ2

                    if (results.length > 0) {
                        // Append the header and subheader if not already appended
                        if (!headerAppended) {
                            // Create a container for header and subheader
                            var headerContainer = document.createElement("div");
                            headerContainer.appendChild(header);
                            if (subHeader) {
                                headerContainer.appendChild(subHeader);
                            }
                            imageGallery.appendChild(headerContainer);
                            headerAppended = true;
                        }

                        results.forEach(result => {
                            if (result && result.element) {
                                cardDeckDiv.appendChild(result.element); // Append sorted elements
                            }
                        });
                        imageGallery.appendChild(cardDeckDiv);
                    }
                    updateImageCount();
                })
                .catch(error => {
                    console.error('Error fetching data for plotType:', plotType, error);
                });
        });
    }


    function populateSubmenus() {
        var xmlhttp;
        if (window.XMLHttpRequest) {
            // code for modern browsers
            xmlhttp = new XMLHttpRequest();
        } else {
            // code for old IE browsers
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }

        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);

                // Clear existing menus if needed
                document.querySelectorAll('.submenu').forEach(menu => menu.innerHTML = '');

                // Loop over each supergroup in the response
                Object.keys(response).forEach(function (superGroupName) {
                    //skip superGroupName that do not equal Physics or Detector
                    if (superGroupName !== "Physics" && superGroupName !== "Detector") {
                        return;
                    }
                    var menuId = superGroupName + 'Submenu'; // create an ID by removing spaces
                    var menu = document.getElementById(menuId);

                    if (menu) {
                        response[superGroupName].forEach(function (item) {
                            var link = document.createElement("a");
                            link.href = "#";
                            link.textContent = item.name;
                            link.className = "dropdown-item";
                            link.setAttribute("data-plotgroup-id", item.id);
                            link.setAttribute("data-toggle", "tooltip");
                            link.setAttribute("title", "Click to view plots for " + item.name);

                            // Disable items that are not "Jets and Heavy Flavor" for PhysicsSubmenu
                            if (superGroupName === "Physics" && item.name !== "Jets and Heavy Flavor") {
                                link.classList.add("disabled");
                                link.setAttribute("aria-disabled", "true");
                                link.style.pointerEvents = "none"; // Disable clicking
                                link.style.opacity = "0.5"; // Optional: make it look disabled
                            }

                            if (superGroupName === "Detector" && item.name !== "Material Scan" && item.name !== "Barrel Imaging Calorimeter") {
                                link.classList.add("disabled");
                                link.setAttribute("aria-disabled", "true");
                                link.style.pointerEvents = "none"; // Disable clicking
                                link.style.opacity = "0.5";
                            }
                            menu.appendChild(link);
                        });
                    } else {
                        console.error('Menu for ' + superGroupName + ' not found');
                    }
                });
            }
        };
        xmlhttp.open("GET", "./php/get_groups.php", true);
        xmlhttp.send();
    }

    function updateImageCount() {
        const imageCount = document.querySelectorAll('#imageGallery .image-item').length;
        document.getElementById('imageCount').innerText = imageCount + " Images";
    }

    function sortImages() {
        const sortSelect = document.getElementById("sortSelect").value;
        const cardDecks = document.querySelectorAll('.d-flex.flex-row.mb-4'); // Get all card decks

        console.log(`Sorting ${cardDecks.length} card decks...`);

        cardDecks.forEach(deck => {
            let colDivs = Array.from(deck.querySelectorAll('.col-md-4')); // Get all card containers in this deck

            // Log the unsorted state for debugging
            console.log('Unsorted cards:', colDivs.map(div => div.getAttribute('data-campaign')));

            // Sort the containers based on the campaign data
            colDivs.sort((a, b) => {
                const campaignA = a.getAttribute('data-campaign').split('.').map(Number);
                const campaignB = b.getAttribute('data-campaign').split('.').map(Number);
                return (sortSelect === 'Oldest' ? 1 : -1) * (campaignA[0] - campaignB[0] || campaignA[1] - campaignB[1]);
            });

            // Log the sorted state for debugging
            console.log('Sorted cards:', colDivs.map(div => div.getAttribute('data-campaign')));

            // Re-append each container in sorted order
            colDivs.forEach(colDiv => deck.appendChild(colDiv));
        });

        console.log("Sorting complete.");
    }

    function loadHomePage() {
        const content = `
                <div class="container-fluid about-section" style="padding-left: 0; padding-right: 0;">
                    <div class="row">
                        <div class="col-md-6">
                            <h1>About</h1>
                            <p>Goal: Central location to view plots produced from ePIC simulations to assist in visualizing and understanding the integrity of the data and identify missing or unexpected results. These plots should be accessible to everyone in the collaboration.</p>
                            <p>Designs and prototypes are developed in Figma and deployed using Javascript, HTML, and CSS.</p>
                            <p>References to the images on this page are stored in a MySQL database. The database tracks the campaign and relevant meta data for each image automatically. Data is fetched from the database using PHP.</p>
                        </div>
                        <div class="col-md-6">
                            <img src="./epic-cutaway-labeled.png" alt="Detector Image">
                        </div>
                    </div>
                </div>

                <footer class="footer">
                    <p><i class="fa-solid fa-triangle-exclamation"></i> Plots on this page are automatically generated and are not approved for use in presentations or other documents. </p>
                </footer>
            `;
        document.getElementById('dynamicContent').innerHTML = content;
    }

    function loadOriginalContent(plotGroup) {
        const content = `<div class="container-fluid">
    <div class="row">
            <div class="col-12 col-md-2 mb-3" id="sidebar"></div>
 
        <div class="col-12 col-md-10 mb-3" id="mainContent">
            <div class="row mb-3 align-items-center" id="galleryInfo">
                <div class="col-12 col-md-4">
                    <span id="imageCount">Count Images</span>
                </div>
                <div class="col-12 col-md-8 d-flex justify-content-end">
                    <!--
                    <div class="input-group" id="searchBar" style="width: 200px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchBar" class="form-control" placeholder="Search..."
                            oninput="filterImages()">
                    </div>-->
                    <select class="form-select ms-2" style="width: 100px;" id="sortSelect">
                        <option value="default">Sort by</option>
                        <option value="Newest">Newest</option>
                        <option value="Oldest">Oldest</option>
                    </select>
                </div>
            </div>
            <div class="row" id="imageGallery"></div>
        </div>
    </div>
</div>`;
        document.getElementById('dynamicContent').innerHTML = content;
        document.getElementById("sortSelect").addEventListener("change", sortImages);
    }

    function populateSidebar(plotGroup) {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);
                const sidebar = document.getElementById('sidebar');
                sidebar.innerHTML = ''; // Clear existing content in the sidebar
    
                // Process each key in the response to create dropdowns with data
                Object.keys(response).forEach(function (key) {
                    if (response[key].length > 0) { // Only create dropdowns if there are options available
                        var label = document.createElement('label');
                        label.setAttribute('for', key + 'Select');
                        label.className = 'form-label';
                        label.textContent = key === 'PlotTypes' ? 'Plot Type' : key;
    
                        var select = document.createElement('select');
                        select.id = key + 'Select';
                        select.className = 'form-select';
                        select.multiple = true;
    
                        // Sort Pipeline options if the key is "Pipeline"
                        let options = response[key];
                        if (key === "Pipeline") {
                            options = options
                                .map(item => parseInt(item)) // Convert Pipeline IDs to integers
                                .sort((a, b) => a - b) // Sort in ascending order
                                .map(item => item.toString()); // Convert back to strings
                        } else if (key === "PlotTypes") {
                            options = options.sort((a, b) => a.Name.localeCompare(b.Name)); // Sort PlotTypes alphabetically by Name
                        }
    
                        // Append options to the select element
                        options.forEach(function (item) {
                            var option = document.createElement('option');
    
                            if (key === 'PlotTypes') {
                                option.value = item.Name;
                                option.textContent = item.DisplayName || item.Description || item.Name;
                            } else {
                                option.value = item;
                                option.textContent = item;
                            }
    
                            select.appendChild(option);
                        });
    
                        if (select.id === "PlotTypesSelect") {
                            var allOption = document.createElement('option');
                            allOption.value = "all";
                            allOption.textContent = "All";
                            allOption.selected = true;
                            select.prepend(allOption);
                        }
    
                        var button = document.createElement('button');
                        button.className = 'btn btn-toggle w-100 text-start align-items-center justify-content-between d-flex';
                        button.type = 'button';
                        button.setAttribute('data-bs-toggle', 'collapse');
                        button.setAttribute('data-bs-target', '#filter' + key);
                        button.setAttribute('aria-expanded', 'false');
                        button.setAttribute('aria-controls', 'filter' + key);
                        button.innerHTML = `${key === 'PlotTypes' ? 'Plot Type' : key} <span id="filter${key}-icon">+</span>`;
    
                        var collapseDiv = document.createElement('div');
                        collapseDiv.className = 'collapse';
                        collapseDiv.id = 'filter' + key;
                        collapseDiv.appendChild(select);
    
                        button.addEventListener('click', function () {
                            var icon = button.querySelector('span');
                            icon.textContent = icon.textContent === '+' ? '-' : '+';
                        });
    
                        if (key === 'Campaign' || key === 'PlotTypes' || key === 'Pipeline') {
                            collapseDiv.classList.add('show');
                            button.setAttribute('aria-expanded', 'true');
                            var icon = button.querySelector('span');
                            icon.textContent = '-';
                        }
    
                        sidebar.appendChild(button);
                        sidebar.appendChild(collapseDiv);
    
                        if (select.id === "CampaignSelect") {
                            if (plotGroup === '28') {
                                Array.from(select.options).forEach(option => {
                                    if (option.value === "24.04.0") {
                                        option.selected = true;
                                    }
                                });
                            } else {
                                select.lastElementChild.selected = true;
                            }
                        }
    
                        if (select.id === "PipelineSelect") {
                            // Select the latest (highest) Pipeline ID by default
                            select.lastElementChild.selected = true;
                        }
                    }
                });
    
                setOnChangeEvents();
                updateImageGallery();
            }
        };
        xmlhttp.open("GET", "./php/generate_sidebar.php?superPlotGroup_ID=" + plotGroup, true);
        xmlhttp.send();
    }
    
    function setOnChangeEvents() {
        var campaignSelect = document.getElementById("CampaignSelect");
        var plotTypeSelect = document.getElementById("PlotTypesSelect");
        var geometrySelect = document.getElementById("GeometrySelect");
        var energySelect = document.getElementById("BeamEnergySelect");
        var minQ2Select = document.getElementById("MinQ2Select");
        var particleTypeSelect = document.getElementById("ParticleTypeSelect");
        var pipelineSelect = document.getElementById("PipelineSelect");

        if (campaignSelect) {
            campaignSelect.onchange = updateImageGallery;
        }
        if (plotTypeSelect) {
            plotTypeSelect.onchange = updateImageGallery;
        }
        if (geometrySelect) {
            geometrySelect.onchange = updateImageGallery;
        }
        if (energySelect) {
            energySelect.onchange = updateImageGallery;
        }
        if (minQ2Select) {
            minQ2Select.onchange = updateImageGallery;
        }

        if (particleTypeSelect) {
            particleTypeSelect.onchange = updateImageGallery;
        }


        if (pipelineSelect) {
            pipelineSelect.onchange = updateImageGallery;
        }
    }

    function downloadCardAsPNG(cardElement, buttonElement) {
        // Find the image within the card
        let imageElement = cardElement.querySelector('img.card-img-top');
        let imageName = imageElement && imageElement.alt ? imageElement.alt.trim().replace(/ /g, '_') : 'default_card_image';
    
        // Check if the image is loaded
        if (!imageElement.complete || imageElement.naturalHeight === 0) {
            // Wait for the image to load before proceeding
            imageElement.addEventListener('load', function onImageLoad() {
                imageElement.removeEventListener('load', onImageLoad);
                proceedWithDownload();
            });
        } else {
            proceedWithDownload();
        }
    
        function proceedWithDownload() {
            // Capture the card
            html2canvas(cardElement, {
                scale: 3,
                onclone: function(clonedDoc) {
                    let clonedButton = clonedDoc.querySelector('.fa-download');
                    if (clonedButton) {
                        clonedButton.style.visibility = 'hidden';
                    }
                }
            }).then(function(canvas) {
                var image = canvas.toDataURL("image/png");
                var link = document.createElement('a');
                link.href = image;
                link.download = `${imageName}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    }

    function filterPlotTypeOptions() {
        var input = document.getElementById("plotTypeSearch").value.toLowerCase();
        var plotTypeSelect = document.getElementById("plotTypeSelect");
        var options = plotTypeSelect.options;

        for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var optionText = option.text.toLowerCase();
            if (optionText.indexOf(input) > -1) {
                option.style.display = ""; // Option matches, show it
            } else {
                option.style.display = "none"; // Option does not match, hide it
            }
        }
    }

    window.onclick = function (event) {
        if (event.target == document.getElementById('modal')) {
            document.getElementById('modal').style.display = 'none';
        }
    }

    function openForm(evt, formName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(formName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    document.getElementById('ciLink').addEventListener('click', function (event) {
        event.preventDefault();

        populateSidebar('38');
        loadOriginalContent('38');
        updateImageGallery();

    });
</script>